---
title: "Advanced plotting"
author: "Thomas Nauss"
date: "19 Oktober 2017"
output: 
  html_document: 
    keep_md: yes
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.path='{{ site.baseurl }}/assets/images/rmd_images/e11-01/')
```

The following plotting examples will show R's generic plotting way. 
The underlaying example data is taken from our crop yield dataset.

```{r, echo=FALSE, warning=FALSE}
library(envimaR)
root_folder = alternativeEnvi(root_folder = "~/edu/mpg-data-analysis/", 
                              alt_env_id = "COMPUTERNAME",
                              alt_env_value = "PCRZP", 
                              alt_env_root_folder = "F:\\BEN\\edu")
source(file.path(root_folder, "moer-mpg-data-analysis/staging/examples/000_set_environment.R"))

path_csv <- paste0(envrmt$path_csv, "csv/")
path_bkg <- paste0(path_data, "bkg/")
path_vectors <- paste0(path_data, "vectors/")
path_rdata <- paste0(path_data, "rdata/")
path_temp <- paste0(filepath_base, "temp/")

cp <- readRDS(file.path(envrmt$path_rdata, "cp_clean.rds"))
```

##### Scatter plot
Scatter plots are probably the most often produced plots since they visualize 
the dependence between two variables in a straight forward manner.

In the following example, we will visualize the number of totally affected 
people against the time line. The aggregation looks like this:
```{r}
dfa <- aggregate(df$total_affected, by = list(df$year), FUN = sum)
colnames(dfa) <- c("year", "total_affected")
```

The lattice way to produce scatter plots is using the `xyplot` function:
```{r}
plot(as.numeric(as.character(cp$Year)), cp$Winter_wheat)
```
The x- and y-axis still show the variable names which is a good thing if you are
not sure what information is plotted on which of the axis. For presenting this
plot to someone else, it might be better to add custom labels and a title.

To add custom lables, use the `xlab` and `ylab` arguments. For the title, use
the `main` argument:
```{r}
plot(dfa$year, dfa$total_affected,
     xlab = "Year", ylab = "Affected persons", 
     main = "Persons affected by natural disasters from 1900 to 2013")
```

If you do not like blue dots, one can of course change the color and symbols
using the `col` and `pch` argument:
```{r}
plot(dfa$year, dfa$total_affected,
     xlab = "Year", ylab = "Affected persons", 
     main = "Persons affected by natural disasters from 1900 to 2013",
     col = "red", pch = 13)
```

And if you want filled symbols, add the `bg` argument (and change to a symbol
which actually can be filled like the one with the number 21). To see the fill
a little better, we also increase the symbol size using `cex`:
```{r}
plot(dfa$year, dfa$total_affected,
     xlab = "Year", ylab = "Affected persons", 
     main = "Persons affected by natural disasters from 1900 to 2013",
     col = "red", bg = "blue", pch = 21, cex = 2)
```

Finally, a logarithmic scale on the y-axis might be of advantage to visually
change the exponential increase to a more linear increase in the number of 
affected persons:
```{r}
dfa$total_affected_sqrt <- dfa$total_affected^0.5^3
plot(dfa$year, dfa$total_affected_sqrt,
     xlab = "Year", ylab = "Affected persons", 
     yaxt = "n",
     main = "Log of persons affected by natural disasters from 1900 to 2013",
     col = "red", bg = "blue", pch = 21, cex = 1)
linear_model <- lm(dfa$total_affected_sqrt ~ dfa$year)
regLine(linear_model)
legend("topleft",legend=paste0("y = ", round(linear_model$coefficients[2],3), 
                                " * x + ",
                                round(linear_model$coefficients[1],3)),bty="n")
ticks <- c(2, 4, 6, 8, 10, 12)
axis(2, at = ticks, labels = ticks^2^3)
qqPlot(linear_model)
```

##### Box-whisker plots
Box-whisker plots visualize some descriptive statistic values of a data set. 

In the following example, we will visualize the distribution of the totally
affected people across the regions. The aggregation looks like this:
```{r}
dfa <- aggregate(as.numeric(df$total_affected), by = list(df$region), FUN = sum)
colnames(dfa) <- c("region", "total_affected")
```

To produce a box whisker plot for the variablity of the number of affected 
persons over all regions, use the `boxplot`function:
```{r}
boxplot(dfa$total_affected, 
        ylab = "Affected persons",
        main = "Persons affected by natural disasters from 1900 to 2013")
```

As you see, you see almost nothing because of the distribution of the data values.
We could use the log = "y" statement again, but a square root transformation 
would also be an option. Why we perform it to the third power of the root is
a storyline we come back for later.
```{r}
boxplot((dfa$total_affected^(0.5)^3),
        ylab = "Third power of the square root of affected persons",
        main = "Persons affected by natural disasters from 1900 to 2013")
```
The individual parts of the plot show the following:

The box includes the distribution of the values located in the second and third 
quartil, thus of the 50% of values which are closest to the mean value.

The median is depicted by the line in the box. The whiskers and representation 
of outliers represent the spread of the values.

The Whiskers mark the remaining values which don't fall into the second and 
third quartile. The length of the whiskers is not standardizized. Often they are
expanded to 1.5*the interquartile range (IQR).

The interquartile range is the range between the lowest value falling into the 
second quartile and the highest value falling into the third quartile.

All values which are higher than 1.5*IQR are considered as outliers and are 
usually marked by points over or under the whiskers, respectively. 

One nice feature of the `boxplot` function is that it can also handel the 
aggregation of a variable. To do that, supply the aggregation variable in the
function. The following example uses the original data frame and computes the
distribution of the totally affected persons across all years for each region:
```{r}
boxplot((total_affected^(0.5)^3) ~ region, data = df,
        ylab = "Third power of the square root of affected persons",
        main = "Persons affected by natural disasters from 1900 to 2013",
        las=2)
```
The x labes are rotated by 90 degree using the las argument.


##### Histogramm plots
Histogramm plots show the frequency distribution of the data. 

In the following example we will use the same aggregated data frame as above and
have a look at the distribution of the affected persons.

A simple histogram can be compute using the `hist` function:
```{r}
hist(dfa$total_affected,
     xlab = "Affected persons",
     main = "Persons affected by natural disasters from 1900 to 2013")
```
As we know already from the plots above, the frequency distribution of the values
is far from normaly distributed. Let's have a look at the log transformation we
used for the scatter plot:
```{r}
hist(log(dfa$total_affected),
     xlab = "Logarithm of affected persons",
     main = "Persons affected by natural disasters from 1900 to 2013")
```
It obisouly results in something quite similar to a normal distribution.

Finally, let's check the square root transoformation used for the box whisker
plots:
```{r}
hist(dfa$total_affected^0.5,
     xlab = "Square root of affected persons",
     main = "Persons affected by natural disasters from 1900 to 2013")
```
That does not change much, but if we increase the power of the root, the resulting
value distribution becomes more and more normaly distributed (except for the 
values:
```{r}
hist(dfa$total_affected^(0.5)^3,
     xlab = "Fourth power of the square root of affected persons",
     main = "Persons affected by natural disasters from 1900 to 2013")
```
